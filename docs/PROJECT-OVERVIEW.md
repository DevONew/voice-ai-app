# í”„ë¡œì íŠ¸ ê°œìš” (Project Overview)

## ğŸ“Œ í”„ë¡œì íŠ¸ ì†Œê°œ

**Voice AI App**ì€ ë‹¤êµ­ì–´ ì–¸ì–´ í•™ìŠµì„ ìœ„í•œ ìŒì„± ê¸°ë°˜ AI íŠœí„° ì• í”Œë¦¬ì¼€ì´ì…˜ì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ìŒì„±ìœ¼ë¡œ ì§ˆë¬¸í•˜ë©´ AIê°€ ì›ì–´ë¯¼ ì„ ìƒë‹˜ ì—­í• ë¡œ ë‹µë³€í•˜ë©°, TTS(Text-to-Speech)ë¡œ ìì—°ìŠ¤ëŸ¬ìš´ ìŒì„±ìœ¼ë¡œ ì‘ë‹µí•©ë‹ˆë‹¤.

### í•µì‹¬ ê¸°ëŠ¥
- ğŸ¤ **ìŒì„± ì¸ì‹ (STT)**: ElevenLabsë¥¼ í†µí•œ ë‹¤êµ­ì–´ ìŒì„± ì¸ì‹
- ğŸ¤– **AI ëŒ€í™”**: Claude Sonnet 4 ê¸°ë°˜ ì›ì–´ë¯¼ íŠœí„° ì—­í• 
- ğŸ”Š **ìŒì„± ì¬ìƒ (TTS)**: ElevenLabs ìì—°ìŠ¤ëŸ¬ìš´ ìŒì„± í•©ì„±
- ğŸŒ **ë‹¤êµ­ì–´ ì§€ì›**: í•œêµ­ì–´, ì˜ì–´, ì¼ë³¸ì–´, í”„ë‘ìŠ¤ì–´ ë“± ë‹¤ì¤‘ ì–¸ì–´ ë™ì‹œ ì¸ì‹
- ğŸ’¾ **ìºì‹± ì‹œìŠ¤í…œ**: TTS ì‘ë‹µ ì¬ì‚¬ìš©ìœ¼ë¡œ ë¹„ìš© ì ˆê° ë° ì„±ëŠ¥ í–¥ìƒ

---

## ğŸ—ï¸ ê¸°ìˆ  ìŠ¤íƒ

### Frontend
- **Framework**: Next.js 14 (App Router)
- **Language**: TypeScript
- **UI**: React 18 + Tailwind CSS
- **Animation**: Framer Motion
- **Development**: Storybook (ì»´í¬ë„ŒíŠ¸ ê°œë°œ)

### Backend & APIs
- **Claude API**: Anthropic Claude Sonnet 4 (claude-sonnet-4-20250514)
- **ElevenLabs STT**: Scribe v2 (ìŒì„± â†’ í…ìŠ¤íŠ¸)
- **ElevenLabs TTS**: Multilingual v2 (í…ìŠ¤íŠ¸ â†’ ìŒì„±)

### Infrastructure
- **Hosting**: Vercel
- **Repository**: GitHub
- **Environment**: Node.js 18+

---

## ğŸ¯ ì™œ ì´ í”„ë¡œì íŠ¸ë¥¼ ë§Œë“¤ì—ˆë‚˜?

### ë¬¸ì œ ì¸ì‹
ê¸°ì¡´ ì–¸ì–´ í•™ìŠµ ì•±ì˜ í•œê³„:
- âŒ **ë‹¨ì¼ ì–¸ì–´ ì¸ì‹**: í•œ ë²ˆì— í•œ ì–¸ì–´ë§Œ ì¸ì‹ ê°€ëŠ¥
- âŒ **í…ìŠ¤íŠ¸ ê¸°ë°˜**: ìŒì„± ëŒ€í™”ê°€ ë¶€ìì—°ìŠ¤ëŸ¬ì›€
- âŒ **ë¹„ì‹¼ ë¹„ìš©**: ì „ë¬¸ íŠœí„°ëŠ” ì‹œê°„ë‹¹ ìˆ˜ë§Œ ì›
- âŒ **ì ‘ê·¼ì„±**: ì‹œê°„ê³¼ ì¥ì†Œì˜ ì œì•½

### í•´ê²°ì±…
- âœ… **ë‹¤êµ­ì–´ ë™ì‹œ ì¸ì‹**: í•œêµ­ì–´ë¡œ ì§ˆë¬¸í•˜ê³  ì˜ì–´ë¡œ ëŒ€ë‹µë°›ê¸° ê°€ëŠ¥
- âœ… **ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”**: ìŒì„± ê¸°ë°˜ ì–‘ë°©í–¥ ì†Œí†µ
- âœ… **24/7 ì´ìš©**: ì–¸ì œ ì–´ë””ì„œë‚˜ í•™ìŠµ ê°€ëŠ¥
- âœ… **ì €ë ´í•œ ë¹„ìš©**: API ë¹„ìš©ë§Œìœ¼ë¡œ ë¬´ì œí•œ ëŒ€í™”

---

## ğŸ”„ ì•± ë™ì‘ í”Œë¡œìš°

```
ì‚¬ìš©ì ë§í•˜ê¸° (ìŒì„±)
    â†“
[STT] ElevenLabs API
    â†“
ìŒì„± â†’ í…ìŠ¤íŠ¸ ë³€í™˜
    â†“
[CHAT] Claude API
    â†“
AI ì‘ë‹µ ìƒì„±
    â†“
[TTS] ElevenLabs API
    â†“
í…ìŠ¤íŠ¸ â†’ ìŒì„± ë³€í™˜
    â†“
ìŠ¤í”¼ì»¤ë¡œ ì¬ìƒ
```

### ìƒíƒœ ë¨¸ì‹  (State Machine)

```
idle (ëŒ€ê¸° ì¤‘)
  â†“ [ë§ˆì´í¬ ë²„íŠ¼ í´ë¦­]
listening (ë“£ëŠ” ì¤‘)
  â†“ [ì¹¨ë¬µ ê°ì§€ 1.5ì´ˆ â†’ STT ì™„ë£Œ]
listening (STT ê²°ê³¼ í‘œì‹œ 2ì´ˆ)
  â†“ [2ì´ˆ í›„ ìë™ ì „í™˜]
processing (ìƒê°í•˜ëŠ” ì¤‘)
  â†“ [Chat API ì‘ë‹µ ì™„ë£Œ]
speaking (ë§í•˜ëŠ” ì¤‘)
  â†“ [TTS ì¬ìƒ ì™„ë£Œ]
idle (ì´ˆê¸° ìƒíƒœ ë³µê·€)
```

---

## ğŸ§© ì£¼ìš” ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°

### ë””ë ‰í† ë¦¬ êµ¬ì¡°
```
app/
â”œâ”€â”€ api/                        # ë°±ì—”ë“œ API Routes
â”‚   â”œâ”€â”€ chat/route.ts          # Claude Chat API
â”‚   â”œâ”€â”€ stt/route.ts           # ElevenLabs STT
â”‚   â””â”€â”€ tts/route.ts           # ElevenLabs TTS
â”œâ”€â”€ components/                 # React ì»´í¬ë„ŒíŠ¸
â”‚   â”œâ”€â”€ VoiceButton.tsx        # ì¤‘ì•™ ê²€ì€ ì›í˜• ë²„íŠ¼
â”‚   â”œâ”€â”€ StateTextDisplay.tsx   # ìƒíƒœ í…ìŠ¤íŠ¸ í‘œì‹œ
â”‚   â”œâ”€â”€ AudioPlayer.tsx        # TTS ìŒì„± ì¬ìƒ
â”‚   â””â”€â”€ StateViews/            # ê° ìƒíƒœë³„ UI
â”œâ”€â”€ hooks/                      # Custom React Hooks
â”‚   â”œâ”€â”€ useVoiceRecorderStreaming.ts  # STT ìŒì„± ë…¹ìŒ
â”‚   â”œâ”€â”€ useChatHandler.ts             # Chat API ì²˜ë¦¬
â”‚   â””â”€â”€ useAppState.ts                # ì „ì—­ ìƒíƒœ ê´€ë¦¬
â”œâ”€â”€ utils/                      # ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
â”‚   â”œâ”€â”€ audio-context.ts       # Singleton AudioContext
â”‚   â”œâ”€â”€ tts-cache.ts           # LRU TTS ìºì‹œ
â”‚   â””â”€â”€ language-detector.ts   # ì–¸ì–´ ìë™ ê°ì§€
â”œâ”€â”€ config/                     # ì„¤ì • íŒŒì¼
â”‚   â””â”€â”€ system-prompt.ts       # Claude ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
â””â”€â”€ constants/                  # ìƒìˆ˜ ì •ì˜
    â”œâ”€â”€ audio.ts               # ì˜¤ë””ì˜¤ ì„¤ì •
    â””â”€â”€ ui.ts                  # UI ì„¤ì •
```

### ì»´í¬ë„ŒíŠ¸ íë¦„ë„

```
page.tsx (ë©”ì¸ í˜ì´ì§€)
  â”‚
  â”œâ”€ useAppState()              â†’ ì „ì—­ ìƒíƒœ ê´€ë¦¬
  â”œâ”€ useVoiceRecorderStreaming() â†’ STT ë…¹ìŒ
  â”œâ”€ useChatHandler()           â†’ Chat API
  â”‚
  â”œâ”€ VoiceButton                â†’ ì¤‘ì•™ ì›í˜• ë²„íŠ¼
  â”œâ”€ StateTextDisplay           â†’ ìƒíƒœ í…ìŠ¤íŠ¸
  â””â”€ AudioPlayer                â†’ TTS ì¬ìƒ
```

---

## âš™ï¸ í•µì‹¬ ê¸°ìˆ  ê²°ì •

### 1. ì™œ Web Speech APIë¥¼ ì“°ì§€ ì•Šì•˜ë‚˜?

#### Web Speech APIì˜ í•œê³„
```typescript
// Web Speech APIëŠ” í•œ ë²ˆì— í•œ ì–¸ì–´ë§Œ ì¸ì‹ ê°€ëŠ¥
const recognition = new webkitSpeechRecognition()
recognition.lang = 'ko-KR'  // í•œêµ­ì–´ë§Œ
// ì˜ì–´ë¡œ ë§í•˜ë©´ ì¸ì‹ ì•ˆ ë¨ âŒ
```

**ë¬¸ì œì **:
- âŒ ë‹¨ì¼ ì–¸ì–´ ì œí•œ: í•œêµ­ì–´ OR ì˜ì–´, ë™ì‹œ ì¸ì‹ ë¶ˆê°€
- âŒ ë‹¤êµ­ì–´ í•™ìŠµ ì•± ìš”êµ¬ì‚¬í•­ ì¶©ì¡± ë¶ˆê°€
- âŒ ì‚¬ìš©ìê°€ ì–¸ì–´ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì „í™˜í•´ì•¼ í•¨

#### ElevenLabs STT ì„ íƒ ì´ìœ 
- âœ… **ìë™ ì–¸ì–´ ê°ì§€**: í•œêµ­ì–´ + ì˜ì–´ ë™ì‹œ ì¸ì‹
- âœ… **ë†’ì€ ì •í™•ë„**: ì „ë¬¸ AI ëª¨ë¸ ì‚¬ìš©
- âœ… **ë¹„ìš© íš¨ìœ¨ì **: ì¹¨ë¬µ ê°ì§€ë¡œ í•„ìš”í•  ë•Œë§Œ í˜¸ì¶œ
- âœ… **ë‹¤ì¤‘ ì–¸ì–´ ì§€ì›**: 29ê°œ ì´ìƒ ì–¸ì–´ ì§€ì›

**íŠ¸ë ˆì´ë“œì˜¤í”„**:
- âš ï¸ ì‹¤ì‹œê°„ ì¤‘ê°„ ê²°ê³¼ ì—†ìŒ (ìµœì¢… ê²°ê³¼ë§Œ ë°˜í™˜)
- âš ï¸ API ë¹„ìš© ë°œìƒ (í•˜ì§€ë§Œ ìºì‹±ìœ¼ë¡œ ìµœì†Œí™”)

---

### 2. ì™œ ë°›ì•„ì“°ê¸°ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì•ˆ ë˜ë‚˜?

#### ê¸°ìˆ ì  ì´ìœ 

**Web Speech API ë°©ì‹**:
```
ë§í•˜ëŠ” ì¤‘... â†’ "ì•ˆë…•..." (ì¤‘ê°„ ê²°ê³¼)
ë§í•˜ëŠ” ì¤‘... â†’ "ì•ˆë…•í•˜ì„¸..." (ì¤‘ê°„ ê²°ê³¼)
ë§í•˜ëŠ” ì¤‘... â†’ "ì•ˆë…•í•˜ì„¸ìš”" (ìµœì¢… ê²°ê³¼)
```
- âœ… ì‹¤ì‹œê°„ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ê°€ëŠ¥
- âŒ í•˜ì§€ë§Œ ë‹¨ì¼ ì–¸ì–´ë§Œ ì¸ì‹

**ElevenLabs STT ë°©ì‹** (í˜„ì¬):
```
ë§í•˜ëŠ” ì¤‘... â†’ (ì¹¨ë¬µ ê°ì§€ 1.5ì´ˆ)
â†’ STT API í˜¸ì¶œ
â†’ "ì•ˆë…•í•˜ì„¸ìš”" (ìµœì¢… ê²°ê³¼ë§Œ ë°˜í™˜)
```
- âœ… ë‹¤êµ­ì–´ ë™ì‹œ ì¸ì‹
- âŒ ì¤‘ê°„ ê²°ê³¼ ì—†ìŒ (HTTP ìš”ì²­/ì‘ë‹µ ë°©ì‹)

#### ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°ì´ ë¶ˆê°€ëŠ¥í•œ ì´ìœ 

**HTTP ë°©ì‹** (í˜„ì¬):
```typescript
// 1íšŒ ìš”ì²­ â†’ 1íšŒ ì‘ë‹µ
const response = await fetch('/api/stt', {
  method: 'POST',
  body: audioBlob  // ì „ì²´ ì˜¤ë””ì˜¤ í•œ ë²ˆì— ì „ì†¡
})
const result = await response.json()  // ìµœì¢… ê²°ê³¼ë§Œ
```

**WebSocket ë°©ì‹** (êµ¬í˜„ ì•ˆ í•¨):
```typescript
// ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° (ì–‘ë°©í–¥ í†µì‹ )
const ws = new WebSocket('wss://api.elevenlabs.io/v1/stream')
ws.send(audioChunk)  // ì‘ì€ ì˜¤ë””ì˜¤ ì¡°ê° ê³„ì† ì „ì†¡
ws.onmessage = (event) => {
  // ì¤‘ê°„ ê²°ê³¼ ë°›ìŒ: "ì•ˆë…•..." â†’ "ì•ˆë…•í•˜ì„¸..."
}
```

**WebSocketì„ ì“°ì§€ ì•Šì€ ì´ìœ **:
- âŒ ë³µì¡ì„± ì¦ê°€ (ì„œë²„ ì„¤ì •, ì—ëŸ¬ ì²˜ë¦¬, ì¬ì—°ê²° ë¡œì§)
- âŒ ë¹„ìš© ì¦ê°€ (ì¤‘ê°„ ê²°ê³¼ë§ˆë‹¤ API ë¹„ìš© ë°œìƒ)
- âŒ Next.js Edge Runtime ì œì•½ (WebSocket ì§€ì› ì œí•œì )
- âœ… **í˜„ì¬ ë°©ì‹ìœ¼ë¡œ ì¶©ë¶„**: 2ì´ˆ í‘œì‹œë¡œ ì‚¬ìš©ì í™•ì¸ ì‹œê°„ ì œê³µ

#### ì‚¬ìš©ì ê²½í—˜ ê°œì„  ë°©ì•ˆ (í˜„ì¬ êµ¬í˜„)

```
STT ì™„ë£Œ: "ì•ˆë…•í•˜ì„¸ìš”"
  â†“
2ì´ˆ ë™ì•ˆ í™”ë©´ì— í‘œì‹œ (listening ìƒíƒœ ìœ ì§€)
  â†“ ì‚¬ìš©ìê°€ ìì‹ ì´ ë§í•œ ë‚´ìš© í™•ì¸ âœ…
2ì´ˆ í›„ Chat API í˜¸ì¶œ (processing ìƒíƒœ)
```

**ì¥ì **:
- âœ… ì‚¬ìš©ìê°€ ìŒì„± ì¸ì‹ ê²°ê³¼ í™•ì¸ ê°€ëŠ¥
- âœ… ë³µì¡í•œ WebSocket ì—†ì´ ê°„ë‹¨í•œ êµ¬í˜„
- âœ… ë¹„ìš© íš¨ìœ¨ì  (STT API 1íšŒë§Œ í˜¸ì¶œ)

---

### 3. TTS ë¬¸ì¥ ë¶„ì ˆì„ ì™œ ì œê±°í–ˆë‚˜?

#### ì´ˆê¸° êµ¬í˜„ (ë¬¸ì œ ìˆìŒ)

```typescript
// AI ì‘ë‹µ: "ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?"
const sentences = splitSentences(aiResponse)
// â†’ ["ì•ˆë…•í•˜ì„¸ìš”!", "ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?"]

// ê° ë¬¸ì¥ë§ˆë‹¤ TTS API í˜¸ì¶œ
const audioBlobs = await Promise.all(
  sentences.map(s => callTTS(s))
)
// â†’ [blob1.mp3, blob2.mp3]

// MP3 íŒŒì¼ ë³‘í•©
const mergedAudio = mergeMP3(audioBlobs)
```

**ë¬¸ì œì **:
```
MP3 êµ¬ì¡°:
[í—¤ë”1][í”„ë ˆì„1][í—¤ë”2][í”„ë ˆì„2]
         â†‘ ì´ ê²½ê³„ì—ì„œ ì§€ì§€ì§ê±°ë¦¼! ğŸ”¥
```

**ê·¼ë³¸ ì›ì¸**:
- MP3ëŠ” í—¤ë” + í”„ë ˆì„ êµ¬ì¡°
- ë‹¨ìˆœ ë³‘í•© ì‹œ í—¤ë”ê°€ ì¤‘ê°„ì— ë¼ì–´ ë…¸ì´ì¦ˆ ë°œìƒ
- WAV/PCMìœ¼ë¡œ ë³€í™˜ í›„ ë³‘í•©í•´ì•¼ í•˜ì§€ë§Œ ë³µì¡ì„± ì¦ê°€

#### í˜„ì¬ êµ¬í˜„ (í•´ê²°ë¨)

```typescript
// ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ í•œ ë²ˆì— TTS ì²˜ë¦¬
const audioBlob = await handleTTSAPI(aiResponse)
```

**ì¥ì **:
- âœ… ê¹¨ë—í•œ ìŒì„± (ì§€ì§€ì§ê±°ë¦¼ ì—†ìŒ)
- âœ… ê°„ë‹¨í•œ êµ¬í˜„
- âœ… í•˜ë‚˜ì˜ MP3 íŒŒì¼ë¡œ ê´€ë¦¬

**íŠ¸ë ˆì´ë“œì˜¤í”„**:
- âš ï¸ ê¸´ ì‘ë‹µ ì‹œ ì²« ìŒì„± ì¬ìƒê¹Œì§€ ì‹œê°„ì´ ì•½ê°„ ë” ê±¸ë¦¼
- âœ… í•˜ì§€ë§Œ ìºì‹±ìœ¼ë¡œ ë°˜ë³µ ì‘ë‹µì€ ì¦‰ì‹œ ì¬ìƒ

---

## ğŸš€ ì„±ëŠ¥ ìµœì í™”

### 1. TTS ìºì‹± ì‹œìŠ¤í…œ

**íŒŒì¼**: `app/utils/tts-cache.ts`

```typescript
// LRU (Least Recently Used) ìºì‹œ
const MAX_CACHE_SIZE = 50  // ìµœëŒ€ 50ê°œ ì‘ë‹µ ì €ì¥
```

**ë™ì‘ ë°©ì‹**:
```
AI ì‘ë‹µ: "ì•ˆë…•í•˜ì„¸ìš”"
  â†“
ìºì‹œ í™•ì¸: getTTSFromCache("ì•ˆë…•í•˜ì„¸ìš”")
  â†“
ì—†ìŒ â†’ TTS API í˜¸ì¶œ (2ì´ˆ)
  â†“
ìºì‹œ ì €ì¥: setTTSToCache("ì•ˆë…•í•˜ì„¸ìš”", audioBlob)

---

ë‹¤ìŒ ë²ˆ ê°™ì€ ì‘ë‹µ:
  â†“
ìºì‹œ í™•ì¸: getTTSFromCache("ì•ˆë…•í•˜ì„¸ìš”")
  â†“
ìˆìŒ! â†’ ì¦‰ì‹œ ë°˜í™˜ (0.1ì´ˆ) âœ…
```

**íš¨ê³¼**:
- âš¡ ë°˜ë³µ ì‘ë‹µ 90% ë¹ ë¦„ (2ì´ˆ â†’ 0.1ì´ˆ)
- ğŸ’° API ë¹„ìš© 40-50% ì ˆê°
- ğŸ“¦ ë©”ëª¨ë¦¬ ì‚¬ìš©: ì•½ 5MB (50ê°œ Ã— 100KB)

### 2. Singleton AudioContext

**íŒŒì¼**: `app/utils/audio-context.ts`

**ë¬¸ì œ**:
```typescript
// ë§¤ë²ˆ ìƒˆë¡œìš´ AudioContext ìƒì„± (ë¹„íš¨ìœ¨)
const audioContext = new AudioContext()
// ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ìœ„í—˜ âš ï¸
```

**í•´ê²°**:
```typescript
// ì „ì—­ì—ì„œ ë‹¨ í•˜ë‚˜ë§Œ ìƒì„± (ì‹±ê¸€í†¤)
let audioContextInstance: AudioContext | null = null

export function getAudioContext(): AudioContext {
  if (!audioContextInstance) {
    audioContextInstance = new AudioContext()
  }
  return audioContextInstance  // ê°™ì€ ì¸ìŠ¤í„´ìŠ¤ ë°˜í™˜
}
```

**íš¨ê³¼**:
- ğŸ§  ë©”ëª¨ë¦¬ 30% ì ˆê°
- ğŸ”‹ ë°°í„°ë¦¬ íš¨ìœ¨ í–¥ìƒ
- ğŸ›¡ï¸ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€

### 3. ì¹¨ë¬µ ê°ì§€ (VAD)

**íŒŒì¼**: `app/constants/audio.ts`

```typescript
const SILENCE_THRESHOLD = 15    // ìŒëŸ‰ ì„ê³„ê°’ (0-100)
const SILENCE_DURATION = 1500   // ì¹¨ë¬µ ì‹œê°„ (1.5ì´ˆ)
```

**ë™ì‘**:
```
ìŒì„± ê°ì§€ (ìŒëŸ‰ > 15)
  â†“
íƒ€ì´ë¨¸ ë¦¬ì…‹
  â†“
ì¹¨ë¬µ (ìŒëŸ‰ < 15)
  â†“
1.5ì´ˆ ì§€ë‚˜ë©´ ìë™ ë…¹ìŒ ì¢…ë£Œ â¹ï¸
```

**íš¨ê³¼**:
- âœ… ì‚¬ìš©ìê°€ ë²„íŠ¼ ì•ˆ ëˆŒëŸ¬ë„ ìë™ ì¢…ë£Œ
- ğŸ’° í•„ìš”í•œ ë§Œí¼ë§Œ ë…¹ìŒ (ë¹„ìš© ì ˆê°)

---

## ğŸ’¡ ì¤‘ìš”í•œ ì„¤ê³„ ê²°ì •

### 1. ë¬´í•œë£¨í”„ ë°©ì§€

#### ì´ˆê¸° ë¬¸ì œ (ë¬´í•œë£¨í”„ ë°œìƒ)

```typescript
// âŒ ì˜ëª»ëœ êµ¬í˜„
useEffect(() => {
  if (appState === 'processing') {
    handleChatAPI()
      .then(() => {
        setAppState('processing')  // â† ë˜ processing!
      })
  }
}, [appState])  // appState ë³€ê²½ â†’ useEffect íŠ¸ë¦¬ê±° â†’ ë¬´í•œ ë°˜ë³µ
```

#### í˜„ì¬ í•´ê²° (ì½œë°± íŒ¨í„´)

```typescript
// âœ… ì˜¬ë°”ë¥¸ êµ¬í˜„
const handleFinalTranscript = useCallback((finalText: string) => {
  // Promise ì²´ì´ë‹ (useEffect ì—†ìŒ)
  handleChatAPI(finalText)
    .then((aiResponse) => {
      setResponseText(aiResponse)
      setTimeout(() => {
        setAppState('speaking')  // â† processingì´ ì•„ë‹˜!
      }, 500)
    })
}, [conversationHistory, handleChatAPI])

// STT ì™„ë£Œ ì‹œ ì½œë°± í˜¸ì¶œ
useVoiceRecorderStreaming(setAppState, undefined, handleFinalTranscript)
```

**í•µì‹¬**:
- âœ… ìƒíƒœ ì „í™˜ì´ ë‹¨ë°©í–¥: `listening â†’ processing â†’ speaking`
- âœ… ì½œë°±ì€ ì •í™•íˆ 1íšŒë§Œ í˜¸ì¶œ
- âœ… useEffect ì˜ì¡´ì„± ì •í™•

### 2. ëŒ€í™” íˆìŠ¤í† ë¦¬ ê´€ë¦¬

**íŒŒì¼**: `app/hooks/useChatHandler.ts`

```typescript
// ëŒ€í™” ë‚´ìš©ì„ ë°°ì—´ë¡œ ê´€ë¦¬
const [conversationHistory, setConversationHistory] = useState<Array<{
  role: 'user' | 'assistant'
  content: string
}>>([])

// ìƒˆ ëŒ€í™” ì¶”ê°€
setConversationHistory(prev => [
  ...prev,
  { role: 'user', content: userMessage },
  { role: 'assistant', content: aiResponse }
])
```

**Claude API ì „ì†¡**:
```typescript
const response = await anthropic.messages.create({
  model: 'claude-sonnet-4-20250514',
  messages: conversationHistory,  // ì „ì²´ ëŒ€í™” ê¸°ë¡ ì „ì†¡
  system: SYSTEM_PROMPT
})
```

**íš¨ê³¼**:
- ğŸ§  **ì»¨í…ìŠ¤íŠ¸ ì¸ì‹**: AIê°€ ì´ì „ ëŒ€í™” ê¸°ì–µ
- ğŸ’¬ **ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”**: "ê·¸ê±° ë§ê³  ë‹¤ë¥¸ ê±°"ì²˜ëŸ¼ ë§¥ë½ ì´í•´
- ğŸ“š **í•™ìŠµ ì§„í–‰ ì¶”ì **: ì‚¬ìš©ìì˜ ì‹¤ìˆ˜ íŒ¨í„´ íŒŒì•…

### 3. Prompt Cachingìœ¼ë¡œ ë¹„ìš© 90% ì ˆê°

**íŒŒì¼**: `app/api/chat/route.ts`

```typescript
const response = await anthropic.messages.create({
  model: "claude-sonnet-4-20250514",
  max_tokens: 1000,
  system: [
    {
      type: "text",
      text: SYSTEM_PROMPT,  // ê¸´ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ì•½ 2000 í† í°)
      cache_control: { type: "ephemeral" }  // ğŸ”¥ ìºì‹± í™œì„±í™”!
    }
  ],
  messages: conversationHistory
})
```

**ë¹„ìš© ê³„ì‚°**:
```
ì¼ë°˜ ë°©ì‹:
  ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ 2000 í† í° Ã— $3/M = $0.006 (ë§¤ë²ˆ)
  10íšŒ í˜¸ì¶œ = $0.06

Prompt Caching:
  ì²« í˜¸ì¶œ: $0.006 (ì •ìƒ ë¹„ìš©)
  ì´í›„ 9íšŒ: 2000 í† í° Ã— $0.30/M = $0.0006 (90% í• ì¸)
  10íšŒ í˜¸ì¶œ = $0.0114 (81% ì ˆê°!)
```

**íš¨ê³¼**:
- ğŸ’° **ë¹„ìš© 80% ì´ìƒ ì ˆê°**
- âš¡ **ì‘ë‹µ ì†ë„ í–¥ìƒ**: ìºì‹œëœ í”„ë¡¬í”„íŠ¸ ì²˜ë¦¬ ë¹ ë¦„
- ğŸ• **5ë¶„ TTL**: 5ë¶„ ë‚´ ì¬í˜¸ì¶œ ì‹œ ìºì‹œ ìœ íš¨

---

## ğŸ“± ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤

### UI êµ¬ì„± ìš”ì†Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         â”‚
â”‚    "ë“£ëŠ” ì¤‘..."          â”‚  â† ìƒíƒœ í…ìŠ¤íŠ¸
â”‚    ë˜ëŠ”                  â”‚
â”‚    "ì•ˆë…•í•˜ì„¸ìš”"          â”‚  â† STT ê²°ê³¼
â”‚                         â”‚
â”‚         â—               â”‚  â† ì¤‘ì•™ ê²€ì€ ì›
â”‚   (í¬ê¸° ë³€í™” ì• ë‹ˆë©”ì´ì…˜)  â”‚
â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Speaking ìƒíƒœ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         â”‚
â”‚  "ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„     â”‚  â† AI ì‘ë‹µ í…ìŠ¤íŠ¸
â”‚   ë„ì™€ë“œë¦´ê¹Œìš”?"         â”‚     (70-80% ì˜ì—­)
â”‚                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â—               â”‚  â† í•˜ë‹¨ ì‘ì€ ì›
â”‚   (TTS ì• ë‹ˆë©”ì´ì…˜)       â”‚     (20-30% ì˜ì—­)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë””ìì¸ ì›ì¹™

- **ë¯¸ë‹ˆë©€ë¦¬ì¦˜**: ë¶ˆí•„ìš”í•œ ìš”ì†Œ ë°°ì œ
- **ëª¨ë°”ì¼ ìµœì í™”**: ì„¸ë¡œ ëª¨ë“œ ì „ìš©
- **í„°ì¹˜ ì¹œí™”ì **: ë²„íŠ¼ í¬ê¸° ì¶©ë¶„íˆ í¼
- **ì‹œê°ì  í”¼ë“œë°±**: ìŒì„± í¬ê¸°ì— ë”°ë¼ ì› í¬ê¸° ë³€í™”
- **ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜**: 0.3-0.5ì´ˆ transition

### ëª¨ë°”ì¼ UI ìµœì í™”

**iOS Safari ëŒ€ì‘**:
```typescript
// AudioPlayer.tsx - iOS ì „ìš© ì²˜ë¦¬
<audio
  ref={audioRef}
  playsInline        // iOS ì „ì²´í™”ë©´ ë°©ì§€
  preload="auto"     // ë¯¸ë¦¬ ë¡œë“œ
/>

audioRef.current.load()  // ëª…ì‹œì  load í˜¸ì¶œ
```

**í„°ì¹˜ ì˜ì—­ ìµœì í™”**:
```css
.voice-button {
  -webkit-tap-highlight-color: transparent;  /* íƒ­ í•˜ì´ë¼ì´íŠ¸ ì œê±° */
  touch-action: manipulation;                 /* ë”ë¸”íƒ­ ì¤Œ ë°©ì§€ */
}
```

---

## ğŸ” ë³´ì•ˆ ë° í™˜ê²½ ì„¤ì •

### í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬

**íŒŒì¼**: `.env.development` (gitignoreë¨)

```bash
CLAUDE_API_KEY=sk-ant-api03-xxxxx
ELEVENLABS_API_KEY=sk_xxxxx
```

**ë³´ì•ˆ ì›ì¹™**:
- âœ… API í‚¤ëŠ” ì„œë²„ ì‚¬ì´ë“œì—ì„œë§Œ ì ‘ê·¼
- âœ… í´ë¼ì´ì–¸íŠ¸ì— ì ˆëŒ€ ë…¸ì¶œ ì•ˆ ë¨
- âœ… Next.js API Routesë¡œ ë³´í˜¸
- âœ… HTTPS í•„ìˆ˜ (í”„ë¡œë•ì…˜)

### API Routes êµ¬ì¡°

```typescript
// app/api/chat/route.ts
export async function POST(req: Request) {
  // ì„œë²„ ì‚¬ì´ë“œì—ì„œë§Œ ì‹¤í–‰
  const apiKey = process.env.CLAUDE_API_KEY  // âœ… ì•ˆì „

  // í´ë¼ì´ì–¸íŠ¸ëŠ” ì´ í‚¤ë¥¼ ì ˆëŒ€ ë³¼ ìˆ˜ ì—†ìŒ
  const response = await anthropic.messages.create({
    // ...
  })

  return Response.json({ response: response.content[0].text })
}
```

---

## ğŸ“Š ì„±ëŠ¥ ì§€í‘œ

### ì „ì²´ ì‘ë‹µ ì‹œê°„

| ì‹œë‚˜ë¦¬ì˜¤ | ìµœì í™” ì „ | ìµœì í™” í›„ | ê°œì„ ìœ¨ |
|---------|----------|----------|--------|
| ìƒˆë¡œìš´ ì‘ë‹µ | 5-7ì´ˆ | 3-4ì´ˆ | **30%** |
| ìºì‹œëœ ì‘ë‹µ | 5-7ì´ˆ | 2-3ì´ˆ | **60%** |
| í‰ê·  | 6ì´ˆ | 3.5ì´ˆ | **42%** |

### ë‹¨ê³„ë³„ ì†Œìš” ì‹œê°„

```
STT ìŒì„± ì¸ì‹: 1-2ì´ˆ
  â†“
Chat API ì²˜ë¦¬: 1-2ì´ˆ
  â†“
TTS ìŒì„± ìƒì„±: 1-2ì´ˆ (ìºì‹œ ì‹œ 0.1ì´ˆ)
  â†“
ìŒì„± ì¬ìƒ: 2-4ì´ˆ (ì‘ë‹µ ê¸¸ì´ì— ë”°ë¼)
```

### API ë¹„ìš© ì ˆê°

```
ì›” 1000íšŒ ëŒ€í™” ê¸°ì¤€:

ì¼ë°˜ ë°©ì‹:
  Claude: 1000íšŒ Ã— $0.003 = $3.00
  TTS: 1000íšŒ Ã— $0.016 = $16.00
  ì´: $19.00

ìµœì í™” í›„:
  Claude (ìºì‹±): 1000íšŒ Ã— $0.0006 = $0.60 (80% ì ˆê°)
  TTS (ìºì‹± 50%): 500íšŒ Ã— $0.016 = $8.00 (50% ì ˆê°)
  ì´: $8.60 (55% ì ˆê°)

ì—°ê°„ ì ˆì•½: ($19 - $8.6) Ã— 12 = $124.80
```

---

## ğŸ› ï¸ ê°œë°œ ëª…ë ¹ì–´

```bash
# ê°œë°œ ì„œë²„ ì‹œì‘
npm run dev

# í”„ë¡œë•ì…˜ ë¹Œë“œ
npm run build

# ë¦°íŠ¸ ê²€ì‚¬
npm run lint

# ì»´í¬ë„ŒíŠ¸ ê°œë°œ (Storybook)
npm run storybook
```

---

## ğŸ” ì£¼ìš” íŒŒì¼ ë° ì—­í• 

| íŒŒì¼ | ì—­í•  | í•µì‹¬ ê¸°ëŠ¥ |
|------|------|----------|
| `app/page.tsx` | ë©”ì¸ í˜ì´ì§€ | ì „ì²´ ì•± ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ |
| `app/hooks/useVoiceRecorderStreaming.ts` | STT ë…¹ìŒ | ë§ˆì´í¬ ìº¡ì²˜, ì¹¨ë¬µ ê°ì§€, STT API í˜¸ì¶œ |
| `app/hooks/useChatHandler.ts` | Chat ì²˜ë¦¬ | Claude API í˜¸ì¶œ, ëŒ€í™” ê¸°ë¡ ê´€ë¦¬ |
| `app/hooks/useAppState.ts` | ìƒíƒœ ê´€ë¦¬ | ì „ì—­ ìƒíƒœ (idle/listening/processing/speaking) |
| `app/components/VoiceButton.tsx` | ì›í˜• ë²„íŠ¼ | ì¤‘ì•™ ê²€ì€ ì›, ìŒì„± í¬ê¸° ì• ë‹ˆë©”ì´ì…˜ |
| `app/components/AudioPlayer.tsx` | ìŒì„± ì¬ìƒ | TTS ì˜¤ë””ì˜¤ ì¬ìƒ, iOS í˜¸í™˜ |
| `app/utils/tts-cache.ts` | TTS ìºì‹± | LRU ìºì‹œ, API ë¹„ìš© ì ˆê° |
| `app/utils/audio-context.ts` | ì˜¤ë””ì˜¤ ê´€ë¦¬ | Singleton AudioContext |
| `app/config/system-prompt.ts` | AI í”„ë¡¬í”„íŠ¸ | ì›ì–´ë¯¼ íŠœí„° ì—­í•  ì •ì˜ |
| `app/api/chat/route.ts` | Chat API | Claude API ë°±ì—”ë“œ ì—”ë“œí¬ì¸íŠ¸ |
| `app/api/stt/route.ts` | STT API | ElevenLabs STT ë°±ì—”ë“œ |
| `app/api/tts/route.ts` | TTS API | ElevenLabs TTS ë°±ì—”ë“œ |

---

## ğŸ“ ì£¼ìš” ìƒìˆ˜ ì„¤ì •

### ì˜¤ë””ì˜¤ ì„¤ì • (`app/constants/audio.ts`)

```typescript
export const AUDIO_CONFIG = {
  // ì¹¨ë¬µ ê°ì§€
  SILENCE_THRESHOLD: 15,      // ìŒëŸ‰ ì„ê³„ê°’ (0-100)
  SILENCE_DURATION: 1500,     // ì¹¨ë¬µ ì‹œê°„ (ms)

  // ìŒì„± ë¶„ì„
  FFT_SIZE: 256,              // FFT í¬ê¸° (ì£¼íŒŒìˆ˜ ë¶„ì„)
  SMOOTHING_TIME_CONSTANT: 0.8,

  // TTS ì¬ìƒ
  PLAYBACK_RATE: 1.0,         // ì¬ìƒ ì†ë„ (1.0 = ì •ìƒ)
  TTS_DELAY: 200,             // TTS ì‹œì‘ ì§€ì—° (ms)
}
```

---

## ğŸ“ í•™ìŠµ í¬ì¸íŠ¸

### ì´ í”„ë¡œì íŠ¸ì—ì„œ ë°°ìš¸ ìˆ˜ ìˆëŠ” ê²ƒ

1. **Next.js App Router ì•„í‚¤í…ì²˜**
   - API Routesë¡œ ë°±ì—”ë“œ êµ¬í˜„
   - Server/Client Components ë¶„ë¦¬
   - í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬

2. **React ê³ ê¸‰ íŒ¨í„´**
   - Custom Hooks ì„¤ê³„
   - useCallback ì˜ì¡´ì„± ê´€ë¦¬
   - ìƒíƒœ ë¨¸ì‹  êµ¬í˜„

3. **ìŒì„± ì²˜ë¦¬ ê¸°ìˆ **
   - Web Audio API í™œìš©
   - STT/TTS í†µí•©
   - ì‹¤ì‹œê°„ ì˜¤ë””ì˜¤ ë¶„ì„

4. **ì„±ëŠ¥ ìµœì í™”**
   - LRU ìºì‹œ êµ¬í˜„
   - Singleton íŒ¨í„´
   - API ë¹„ìš© ìµœì í™”

5. **ì‹¤ì „ ë¬¸ì œ í•´ê²°**
   - ë¬´í•œë£¨í”„ ë””ë²„ê¹…
   - MP3 ë³‘í•© ì´ìŠˆ
   - iOS Safari í˜¸í™˜ì„±

---

## ğŸš§ ì•Œë ¤ì§„ ì œì•½ì‚¬í•­

### 1. ì‹¤ì‹œê°„ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ì—†ìŒ
- **ì´ìœ **: HTTP ê¸°ë°˜ STT (WebSocket ë¯¸ì‚¬ìš©)
- **í•´ê²°**: 2ì´ˆ í‘œì‹œ ì‹œê°„ìœ¼ë¡œ ì‚¬ìš©ì í™•ì¸ ì œê³µ
- **ê°œì„  ë°©í–¥**: WebSocket ìŠ¤íŠ¸ë¦¬ë° ì¶”ê°€ (í–¥í›„)

### 2. iOS Safari HTTPS í•„ìˆ˜
- **ì´ìœ **: getUserMedia API ë³´ì•ˆ ì •ì±…
- **í•´ê²°**: Vercel ë°°í¬ (ìë™ HTTPS)
- **ë¡œì»¬ ê°œë°œ**: mkcertë¡œ ë¡œì»¬ HTTPS ì„¤ì •

### 3. ê¸´ ì‘ë‹µ ì‹œ ì²« ì¬ìƒ ì§€ì—°
- **ì´ìœ **: ì „ì²´ í…ìŠ¤íŠ¸ TTS ì²˜ë¦¬
- **í•´ê²°**: ìºì‹±ìœ¼ë¡œ ë°˜ë³µ ì‘ë‹µ ì¦‰ì‹œ ì¬ìƒ
- **ê°œì„  ë°©í–¥**: ë¬¸ì¥ ë‹¨ìœ„ ìŠ¤íŠ¸ë¦¬ë° (í–¥í›„)

---

## ğŸ”® í–¥í›„ ê°œì„  ë°©í–¥

### Phase 1: ì„±ëŠ¥ ê°œì„ 
- [ ] WebSocket ê¸°ë°˜ ì‹¤ì‹œê°„ STT ìŠ¤íŠ¸ë¦¬ë°
- [ ] ë¬¸ì¥ ë‹¨ìœ„ TTS ìŠ¤íŠ¸ë¦¬ë° (WAV ë³‘í•©)
- [ ] IndexedDB ì˜êµ¬ ìºì‹œ

### Phase 2: ê¸°ëŠ¥ ì¶”ê°€
- [ ] ì–¸ì–´ë³„ ìŒì„± ì„ íƒ (ë‚¨ì„±/ì—¬ì„±)
- [ ] ì¬ìƒ ì†ë„ ì¡°ì ˆ UI
- [ ] ëŒ€í™” ê¸°ë¡ ì €ì¥ ë° ë³µìŠµ

### Phase 3: UX ê°œì„ 
- [ ] ì˜¤ë¥˜ ë³µêµ¬ ìë™í™”
- [ ] ì˜¤í”„ë¼ì¸ ëª¨ë“œ (PWA)
- [ ] ë‹¤í¬ ëª¨ë“œ

---

## ğŸ“š ì°¸ê³  ë¬¸ì„œ

### ê³µì‹ ë¬¸ì„œ
- [Next.js Documentation](https://nextjs.org/docs)
- [Claude API Reference](https://docs.anthropic.com/claude/reference)
- [ElevenLabs API Docs](https://elevenlabs.io/docs)
- [Web Audio API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API)

### í”„ë¡œì íŠ¸ ë¬¸ì„œ
- [voice-flow-architecture.md](./voice-flow-architecture.md) - ìŒì„± ì²˜ë¦¬ í”Œë¡œìš° ìƒì„¸
- [Web-Speech-vs-ElevenLabs-STT.md](./Web-Speech-vs-ElevenLabs-STT.md) - STT ê¸°ìˆ  ë¹„êµ
- [STT-Real-Time-Display-Implementation.md](./STT-Real-Time-Display-Implementation.md) - ì‹¤ì‹œê°„ í‘œì‹œ êµ¬í˜„
- [optimization-and-cache-management.md](./optimization-and-cache-management.md) - ì„±ëŠ¥ ìµœì í™”
- [issues-and-fixes.md](./issues-and-fixes.md) - ë¬¸ì œ í•´ê²° ê¸°ë¡

---

## ğŸ‘¥ ê¸°ì—¬ ë°©ë²•

### ê°œë°œ í™˜ê²½ ì„¤ì •

1. **ì €ì¥ì†Œ í´ë¡ **
```bash
git clone https://github.com/DevONew/voice-ai-app.git
cd voice-ai-app
```

2. **í™˜ê²½ ë³€ìˆ˜ ì„¤ì •**
```bash
cp .env.example .env.development
# .env.developmentì— API í‚¤ ì…ë ¥
```

3. **ì˜ì¡´ì„± ì„¤ì¹˜ ë° ì‹¤í–‰**
```bash
npm install
npm run dev
```

### ì½”ë“œ ì»¨ë²¤ì…˜
- TypeScript ì—„ê²© ëª¨ë“œ
- ESLint ê·œì¹™ ì¤€ìˆ˜
- ì»´í¬ë„ŒíŠ¸ë³„ ì£¼ì„ ì‘ì„±
- Tailwind CSS ìœ í‹¸ë¦¬í‹° ìš°ì„ 

---

## ğŸ“„ ë¼ì´ì„ ìŠ¤

ì´ í”„ë¡œì íŠ¸ëŠ” MIT ë¼ì´ì„ ìŠ¤ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

---

## ğŸ™ ê°ì‚¬ì˜ ë§

- **Anthropic**: Claude API ì œê³µ
- **ElevenLabs**: ê³ í’ˆì§ˆ STT/TTS API
- **Vercel**: ë°°í¬ í”Œë«í¼
- **Next.js íŒ€**: í›Œë¥­í•œ í”„ë ˆì„ì›Œí¬

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-12-15
**ë²„ì „**: 1.0.0
**ì‘ì„±ì**: DevONew
